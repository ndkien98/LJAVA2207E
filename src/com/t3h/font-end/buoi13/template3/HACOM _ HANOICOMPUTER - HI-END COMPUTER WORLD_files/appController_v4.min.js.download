var app=angular.module("csChatApp.controllers",["ngTouch","nya.bootstrap.select"])
app.directive("fileModel",["$parse",function($parse){return{restrict:"A",link:function(scope,element,attrs){var model=$parse(attrs.fileModel),modelSetter=model.assign
element.bind("change",function(){scope.$apply(function(){modelSetter(scope,element[0].files[0]),scope.onFileSelected(scope)})})}}}]),app.directive("datepicker",function(){return{restrict:"A",require:"ngModel",compile:function(){return{pre:function(scope,element,attrs,ngModelCtrl){var format,dateObj
format=attrs.dpFormat?attrs.dpFormat:"yyyy/mm/dd",attrs.initDate||attrs.dpFormat?attrs.initDate||(scope[attrs.ngModel]=attrs.initDate):(dateObj=new Date,scope[attrs.ngModel]=dateObj.getDate()+"/"+(dateObj.getMonth()+1)+"/"+dateObj.getFullYear()),$(element).datepicker({format:format}).on("changeDate",function(ev){scope.$apply(function(){scope.preventCloseDiv=!0,ngModelCtrl.$setViewValue(moment(ev.date).format(format.toUpperCase()))})}).on("show",function(){$("input").blur()})}}}}}),app.controller("AppController",["$scope","$http","$location","DomainService","$window","$sce","TranslateService","$filter",function($scope,$http,$location,DomainService,$window,$sce,TranslateService,$filter){function syncStorage(domainId){try{if(!domainId||$scope.inApp)$scope.doInitDomain(domain,parentUsername)
else{var data={id:6,type:"syncStorage",value:{chatState:"chatState_"+domainId,deviceKey:"chatState_devicekey_"+domainId}}
parent.postMessage(JSON.stringify(data),"*")}}catch(e){console.error(e)}}function popupCenter(url,title){var newWindow=window.open(url,title)
window.focus&&newWindow.focus()}function endConversation(){var endChat={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(LEAVE_CONVERSATION,endChat),$scope.isValidRating=!0,$scope.chatState.conversation_id="-1",$scope.chatState.agent_name=null,$scope.chatState.agent_avatar=null
var mes=$filter("translate")("LBL_CHAT_ENDED"),logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.isLike=!1,$scope.isDislike=!1,$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,$scope.chatState.replyFromTrigger=0,saveChatStateToStorage(),$scope.isRating=!1,$scope.allowRating=!1,$scope.commentMessage=new Comment,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.changeLandingSendState(!1),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),clearTimeout($scope.tmroutCheckAgentStat),$scope.tmroutCheckAgentStat=setTimeout(function(){restoreChatState()},checkStatTmrDuration)}function stopNotifyTypingToCust(){$scope.isKeyPress=!1
var req={conversationId:$scope.chatState.conversation_id}
send(NOTIFY_STOP_TYPING,req)}function initWorkspace(){sendTrackingEvent("widget_loaded",null),checkChatStatus(),restoreChatState()}function checkChatStatus(){if(null!=$scope.localStorage.getItem("chatState_undefined")&&$scope.localStorage.removeItem("chatState_undefined"),null!=$scope.localStorage.getItem("chatState_"+$scope.domainId)){$scope.chatState=new ChatState
var dataState=JSON.parse($scope.localStorage.getItem("chatState_"+$scope.domainId))
$scope.chatState.setBasicAttr(dataState),(!$scope.chatState.visitorAdditionField||angular.equals($scope.chatState.visitorAdditionField,{}))&&($scope.chatState.visitorAdditionField={},$scope.chatState.setDefaultAdditionFieldsValue($scope.lstAdditionField)),null!=parentUsername&&""!=parentUsername&&$scope.chatState.visitor_name!=parentUsername&&($scope.chatState=null)}else $scope.chatState=null
if((null===$scope.chatState||void 0===$scope.chatState)&&(log("chat_state = null"),$scope.chatState=new ChatState,$scope.chatState.setDefaultAdditionFieldsValue($scope.lstAdditionField)),null!=parentUsername&&""!=parentUsername&&($scope.chatState.visitor_name=parentUsername),null!=parentEmail&&""!=parentEmail&&($scope.chatState.visitor_email!=parentEmail&&($scope.chatState.visitor_id=null),$scope.chatState.visitor_email=parentEmail),null!=parentPhone&&""!=parentPhone&&($scope.chatState.visitor_phone!=parentPhone&&($scope.chatState.visitor_id=null),$scope.chatState.visitor_phone=parentPhone),void 0==$scope.chatState.enableSound&&($scope.chatState.enableSound=!0),$scope.addNewVersionChatStateInfo(),$scope.chatState.history)for(var i=0;i<$scope.chatState.history.length;i++){var temp=jQuery.extend(!0,{},$scope.chatState.history[i])
temp.content=getMessageChat(temp.content),$scope.listMessage.push(temp)}if(1==$scope.listService.length)$scope.chatState.service_id=$scope.listService[0].serviceId
else{var selectName=$filter("translate")("LBL_SELECT_ONE_SERVICE")
$scope.listService.unshift({serviceId:"-1",serviceName:selectName})}return $scope.login.selectedService=$scope.listService[0],$scope.login.content="",$scope.visitorInfo.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone),saveChatStateToStorage(),$scope.chatState}function markLanding(){if(!getCookie("chatState_sourceUrl_"+$scope.domainId)){var host=document.location.host
parent!==window&&(host=document.referrer)
var sourceURL={landing:host,referrer:$scope.referrer,isSentBefore:!1,test:"1"}
setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(sourceURL),"")}}function restoreChatState(){if(null!==$scope.chatState&&"undefined"!==$scope.chatState){log("restoring chat state"),console.warn($scope.chatState)
var requestResumeSession={visitorId:$scope.chatState.visitor_id,service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,domain:$scope.domainCode}
sendWaitForConnection(CUSTOMER_RESUMING_REQUEST,requestResumeSession)}}function setLandingTime(){if($scope.currentTimeOnSite=(new Date).getTime()/1e3|0,$scope.browserInfo=new $.jqx.response,"undefined"!=typeof Storage){if(!$scope.sessionStorage.getItem("cs_landingtime")){var landingtime=(new Date).getTime()/1e3|0
try{sessionStorage.setItem("cs_landingtime",landingtime)}catch(err){console.log("setLandingTime: sessionStorage disabled, using parent sessionStorage")}finally{$scope.sessionStorage.setItem("cs_landingtime",landingtime)}var datasend={id:6,type:"saveLandingTime",value:{name:"cs_landingtime",value:landingtime}}
parent.postMessage(JSON.stringify(datasend),"*")}}else log("Browser not supported storage")}function getQueryString(){notifyNewMessage("getPageUrl"),isMobile.any()&&($scope.isMobile=!0)
var q=$location.search(),queryString=atob(decodeURIComponent(q.key))
domain=getParameterByName("domain",queryString),parentUsername=getParameterByName("username",queryString),color=getParameterByName("color",queryString),parentEmail=getParameterByName("email",queryString),parentPhone=getParameterByName("phone",queryString),isAuto=getParameterByName("auto",queryString),pageTitle=getParameterByName("pageTitle",queryString),referrer=getParameterByName("referrer",queryString),hidePopup=1==getParameterByName("hide",queryString),domainId=getParameterByName("domainId",queryString),fbToken=getParameterByName("token",queryString),$scope.inApp=getParameterByName("inApp",queryString),language=getParameterByName("language",queryString),null!=parentUsername&&""!=parentUsername&&($scope.isDisable.username=!0),null!=parentEmail&&""!=parentEmail&&isValidEmailAddress(parentEmail)&&($scope.isDisable.email=!0),null!=parentPhone&&""!=parentPhone&&isValidPhoneNumber(parentPhone)&&($scope.isDisable.phone=!0),null!=pageTitle&&""!=pageTitle&&($scope.pageTitle=pageTitle),null!=referrer&&""!=referrer&&($scope.referrer=referrer),domainId&&($scope.hasDomainIdEmbed=!0),syncStorage(domainId)}function send(service,data){var packet={service:service,data:data}
if(webPush.send(packet),log("Client send: "+JSON.stringify(packet)),service===MESSAGE){var senderAgentId=null,content=data.message,logChat=new Message(senderAgentId,1,content),logChatData=new Message(senderAgentId,1,getMessageChat(content))
$scope.chatState.history.push(logChat),$scope.listMessage.push(logChatData),saveChatStateToStorage()}}function sendWaitForConnection(service,data){var packet={service:service,data:data}
if(webPush.sendWait(packet),log("Client sendWait: "+JSON.stringify(packet)),service===MESSAGE){var senderAgentId=null,content=data.message,logChat=new Message(senderAgentId,1,content),logChatData=new Message(senderAgentId,1,getMessageChat(content))
$scope.chatState.history.push(logChat),$scope.listMessage.push(logChatData),saveChatStateToStorage()}}function getMessageChat(text){return $sce.trustAsHtml(urlify(htmlEncode(text).replace(/(?:\r\n|\r|\n)/g,"<br/>")))}function urlify(text){var urlRegex=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;()]*[-A-Z0-9+&@#\/%=~_|])/gi
return text.replace(urlRegex,function(url){return url.trim()==text.trim()&&isImageLink(url)?'<a href="'+url+'" target="_blank"><img src="'+url+'" style="max-height:110px;max-width: 100%"/></a>':'<a href="'+url+'" target="_blank">'+url+"</a>"})}function htmlEncode(value){return $("<div/>").text(value).html()}function saveChatStateToStorage(){$scope.localStorage.setItem("chatState_"+$scope.domainId,JSON.stringify($scope.chatState))
var data={id:6,type:"saveIfrChatState",value:{name:"chatState_"+$scope.domainId,value:JSON.stringify($scope.chatState)}}
parent.postMessage(JSON.stringify(data),"*")}function sessionLogout(){if($scope.chatState.agent_name="",$scope.chatState.agent_group="",1==$scope.listService.length||($scope.chatState.service_id=-1),$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,$scope.sendOfflineError=!1,null!=$scope.chatState.visitor_name&&""!=$scope.chatState.visitor_name?$scope.visitorInfo.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone):$scope.visitorInfo.setBasicInfo(parentUsername,parentEmail,parentPhone),$scope.login.setBasicInfo($scope.visitorInfo.visitorName,$scope.visitorInfo.visitorEmail,$scope.visitorInfo.visitorPhone),$scope.login.setAdditionFields($scope.lstAdditionField,$scope.chatState.visitorAdditionField),$scope.chatState.conversation_id="-1",$scope.chatState.replyFromTrigger=0,$scope.chatState.history=[],$scope.listMessage=[],$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.isChatting=!1,$scope.isSignin=!1,$scope.chatState.triggerState&&$scope.chatState.triggerState.length>0)for(var i=0;i<$scope.lstTrigger.length;i++)for(var j=0;j<$scope.chatState.triggerState.length;j++)if($scope.chatState.triggerState[j].id==$scope.lstTrigger[i].id&&1!=$scope.lstTrigger[i].fire_once){$scope.chatState.triggerState.splice(j,1)
break}}function restoreChatBox(){$scope.isChatting=!0,$scope.chatState.chat_windows_maximum!==!0||$scope.isMobile?(notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),$scope.maximize=!1):(notifyNewMessage("openChatBox"),$scope.maximize=!0),$scope.sendOfflineError=!1,""==$scope.chatState.agent_name?($scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault):($scope.agentName=$scope.chatState.agent_name,$scope.agentDescription=$scope.chatState.agent_group,$scope.avatar=$scope.chatState.agent_avatar?$scope.chatState.agent_avatar:$scope.agentAvatarDefault,$scope.allowRating=!0),""!==$scope.chatState.visitor_name?($scope.isSignin=!0,$scope.visitorInfo.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone),$scope.login.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone),$scope.login.setAdditionFields($scope.lstAdditionField,$scope.chatState.visitorAdditionField),$scope.userInfo.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone),$scope.userInfo.setAdditionFields($scope.lstAdditionField,$scope.chatState.visitorAdditionField),$scope.isLike=$scope.chatState.isLike,$scope.isDislike=$scope.chatState.isDislike,$scope.newMessage=$scope.chatState.unreadCount):$scope.isSignin=!1}function getHostName(url){var match=url.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i)
return null!=match&&match.length>2&&"string"==typeof match[2]&&match[2].length>0?match[2]:null}function setCookie(name,value,days){var expires
if(days){var date=new Date
date.setTime(date.getTime()+24*days*60*60*1e3),expires=";expires="+date.toUTCString()}else expires=""
document.cookie=name+"="+value+expires+";path=/;SameSite=None; Secure"}function getCookie(cname){for(var name=cname+"=",decodedCookie=decodeURIComponent(document.cookie),ca=decodedCookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "==c.charAt(0);)c=c.substring(1)
if(0==c.indexOf(name))return c.substring(name.length,c.length)}return""}function isImageLink(url){var regex=/\.(jpg|jpeg|tiff|gif|png)$/
return regex.test(url.split("?")[0].toLowerCase())}function requestFirstLogin(){if(isFirstLogin===!1){log("-------------------------------request login first time-------------------------------")
var chatState
chatState=null!=$scope.localStorage.getItem("chatState_"+$scope.domainId)?JSON.parse($scope.localStorage.getItem("chatState_"+$scope.domainId)):$scope.chatState
var response=new $.jqx.response,os=response.os,browser=response.browser,device=response.device,host=document.location.host
parent!==window&&(host=document.referrer)
var requestLogin={visitorId:chatState.visitor_id,ip:userIp,country_name:city,host:getHostName($scope.currentPageUrl),domain:$scope.domainCode,os:os.name+" "+os.version+" "+os.platform,browser:browser.name+" "+browser.version,device_type:device.type,accountId:$scope.accountId,token:fbToken}
if(send(CUSTOMER_LOGIN,requestLogin),$scope.login.username||$scope.login.email||$scope.login.phone){var infoVisitor=new InfoVisitor
infoVisitor.setBasicInfo($scope.login.username,$scope.login.email,$scope.login.phone),infoVisitor.setAdditionInfo($scope.lstAdditionField,$scope.chatState.visitorAdditionField),$scope.visitorInfo.setBasicInfo($scope.login.username,$scope.login.email,$scope.login.phone),send(UPDATE_VISITOR_INFO,infoVisitor)}var url={url:$scope.currentPageUrl,title:$scope.pageTitle?$scope.pageTitle:null,referrer:$scope.referrer?$scope.referrer:null}
send(VISITOR_VISIT_PATH_URL,url),$scope.hasDomainIdEmbed||send(AGENT_SEND_AUDIT_LOG,{message:"domain_chua_nhung_lai_code",domain:domain})}}function notifyNewMessage(action){var data={id:6,type:action,manual:$scope.userOpenChatBoxManually}
parent.postMessage(JSON.stringify(data),"*"),parent.postMessage(action,"*")}function displayMessage(evt){try{evt=JSON.parse(evt.data),1==evt.id&&$scope.openChatBox(),2==evt.id&&$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),3==evt.id&&(evt.value.chatState&&$scope.localStorage.setItem("chatState_"+domainId,evt.value.chatState),evt.value.deviceKey&&$scope.localStorage.setItem("chatState_devicekey_"+domainId,evt.value.deviceKey),evt.value.landingtime&&$scope.sessionStorage.setItem("cs_landingtime",evt.value.landingtime),evt.value.csdebug&&(showLog=!0),$scope.doInitDomain(domain,parentUsername)),4==evt.id&&($scope.currentPageUrl=evt.url),5==evt.id&&$scope.onUrlChangedSPA(evt.url),$scope.$digest()}catch(err){log(err)}}function getVisitorCurrentURL(){var host=document.location.host
return parent!==window&&(host=document.referrer),host}function sendTrackingEvent(action,data){var dataSend={id:7,type:action,data:data}
parent.postMessage(JSON.stringify(dataSend),"*")}$scope.$window=$window,$scope.hasDomainIdEmbed=!1,webPush.onConnected=function(){console.log("socket connected"),$scope.disconnectChat=!1,$scope.connecting=!1,$scope.$digest()},webPush.onDisconnected=function(){$scope.disconnectChat=!0,$scope.connecting=!1,$scope.$digest()}
var parentUsername="",parentEmail="",parentPhone="",isAuto=!0,hidePopup=!1,pageTitle="",referrer="",isSynced=!1,domainId="",checkStatTmrDuration=CHECK_AGENT_STATUS_TIMEOUT,fbToken="",language="",domain="",color=""
$scope.inApp=!1,$scope.currentPageUrl="",$scope.isDisable={username:!1,email:!1,phone:!1},$scope.localStorage=new IFLocalStorage,$scope.sessionStorage=new IFSessionStorage,$scope.backgroundColor="transparent",$scope.offTitle=$filter("translate")("LBL_LEAVE_MESSAGE"),$scope.onTitle=$filter("translate")("LBL_CHAT_US"),$scope.agentNameDefault=$filter("translate")("LBL_AGENT_DEFAULT"),$scope.agentDescriptionDefault=$filter("translate")("LBL_DESCRIPTION_DEFAULT"),$scope.agentAvatarDefault="https://s2.caresoft.vn:8090/images/avatar_simple_agent.png",$scope.offlineInfo=$filter("translate")("LBL_OFFLINE_INFO"),$scope.offlineSuccess=$filter("translate")("LBL_OFFLINE_SUCCESS"),$scope.agentBusyDefault=$filter("translate")("LBL_NO_AGENT_AVAILABLE"),$scope.homepage="#",$scope.titleLogo="Powered by Caresoft",$scope.logo="images/cs.png",$scope.newMessage=0,$scope.chat=!1,$scope.message=!1,$scope.survey=!1,$scope.myFile="",$scope.preventCloseDiv=!1,$scope.maximize=!1,$scope.isChatting=!1,$scope.isRating=!1,$scope.sentNotify=!1,$scope.allowRating=!1,$scope.isSignin=!1,$scope.isClickSignin=!1,$scope.isEditInfo=!1,$scope.isClickOption=!1,$scope.isConfirmEnd=!1,$scope.requiredName=!1,$scope.requiredEmail=!1,$scope.requiredPhone=!1,$scope.requiredContent=!1,$scope.requireService=!1,$scope.invalidEmail=!1,$scope.invalidPhone=!1,$scope.disconnectChat=!0,$scope.connecting=!0,$scope.uploading=!1,$scope.isOffline=!1,$scope.enableEmail=!0,$scope.requireEmail=!0,$scope.enablePhone=!1,$scope.requirePhone=!1,$scope.sendOfflineError=!1,$scope.isSendOffline=!1,$scope.loggedinFirstTime=!1,$scope.isCustomerChatting=!1,$scope.currentLikeState=null,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.needSignin=!1,$scope.listService=[],$scope.chatMessage={},$scope.listMessage=[],$scope.listHistory=[],$scope.visitorName="",$scope.visitorEmail="",$scope.surveyVisitorName="",$scope.isLike=!1,$scope.isDislike=!1,$scope.listServiceStr="",$scope.isMobile=!1,$scope.isTypingChat=!1,$scope.isTyping=!1,$scope.isKeyPress=!1
var isClearTimeout=!1,autoLoginTimeout=!1
$scope.isAutoPopupRequire=!1,$scope.isParentFocused=!1,$scope.chatState=null,$scope.isChangeUserInfo=!1,$scope.userOpenChatBoxManually=!1,$scope.lstAdditionField=[],$scope.userInfo=new UserInfo,$scope.commentMessage=new Comment,$scope.login=new LoginUser,$scope.visitorInfo=new VisitorInfo,$scope.currentResumeState=0,$scope.tmroutCheckAgentStat=null
var timeoutTyping,userIp="",city="",messageAudio=new Audio("../images/triad_gbd.mp3"),isTouchEvent="ontouchstart"in window,triggerIntvl=[]
$scope.openChatBox=function(isOpenManually){isClearTimeout=!0,isOpenManually&&($scope.userOpenChatBoxManually=!0),$scope.useFacebook?popupCenter("https://www.messenger.com/t/"+$scope.pageId,"Chat Facebook"):(notifyNewMessage("openChatBox"),$scope.maximize=!0,$scope.newMessage=$scope.chatState.unreadCount=0,$scope.chatState.chat_windows_maximum=!0,saveChatStateToStorage(),requestFirstLogin(),autoLoginTimeout&&clearTimeout(autoLoginTimeout),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")))},$scope.closeChatBox=function(){isClearTimeout=!0,$scope.chatState.chat_windows_maximum=!1,$scope.maximize=!1,$scope.userOpenChatBoxManually=!1,notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),saveChatStateToStorage()},$scope.changeSound=function(){$scope.chatState.enableSound=!$scope.chatState.enableSound,saveChatStateToStorage()},$scope.sendLandingInfo=function(conversationId){if(getCookie("chatState_sourceUrl_"+$scope.domainId)){var source=JSON.parse(getCookie("chatState_sourceUrl_"+$scope.domainId))
source.isSentBefore||(source.isSentBefore=!0,setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(source)),source.conversationId=conversationId,send(CUSTOMER_UPDATE_SOURCEURL,source))}},$scope.changeLandingSendState=function(state){if(getCookie("chatState_sourceUrl_"+$scope.domainId)){var source=JSON.parse(getCookie("chatState_sourceUrl_"+$scope.domainId))
source.isSentBefore=state,setCookie("chatState_sourceUrl_"+$scope.domainId,JSON.stringify(source))}},$scope.startTyping=function(){$scope.isTypingChat=!0},$scope.stopTyping=function(){$scope.isTypingChat=!1},$scope.startChat=function(){var name=null==$scope.login.username?"":$scope.login.username.trim(),email=null==$scope.login.email?"":$scope.login.email.trim(),phone=null==$scope.login.phone?"":$scope.login.phone.trim()
null!=$scope.login.selectedService&&!angular.equals($scope.login.selectedService,{})||1!=$scope.listService.length||($scope.login.selectedService=$scope.listService[0])
var service=$scope.login.selectedService,content=$scope.login.content
$scope.validateUser(name,email,phone)
var afValid=$scope.login.validateAdditionFields($scope.lstAdditionField)
if(""==content?$scope.requiredContent=!0:$scope.requiredContent=!1,-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1,!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requiredContent||$scope.requireService)&&afValid){if($scope.login.content="",""!=name){$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone,$scope.chatState.setAdditionFields($scope.lstAdditionField,$scope.login),$scope.visitorInfo.setBasicInfo($scope.chatState.visitor_name,$scope.chatState.visitor_email,$scope.chatState.visitor_phone),$scope.visitorInfo.setAdditionFields($scope.lstAdditionField,$scope.login)
var infoVisitor=new InfoVisitor
infoVisitor.setBasicInfo(name,email,phone),infoVisitor.setAdditionInfo($scope.lstAdditionField,$scope.login),send(UPDATE_VISITOR_INFO,infoVisitor),$scope.isSignin=!0}var sendMessage={service_id:service.serviceId,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:content,fromTrigger:$scope.chatState.replyFromTrigger,logging:"Sending from Startchat"}
"-1"==sendMessage.conversationId&&(sendMessage.lstTriggerMsg=gatherTriggerMsg($scope.chatState.history),$scope.isCustomerChatting=!0),$scope.chatState.chatting=!0,send(MESSAGE,sendMessage)
var sendMenu={serviceId:service.serviceId}
send(LIVECHAT_GET_PERSISTENT_MENU,sendMenu),$scope.chatState.service_id=service.serviceId,saveChatStateToStorage(),$scope.isChatting=!0,sendTrackingEvent("start_chat",null),clearTimeout($scope.tmroutCheckAgentStat)}},$scope.sendAnother=function(){$scope.sentNotify=!1,$scope.login.content=""},$scope.sendOffline=function(){$scope.sendOfflineError=!1
var name=null==$scope.login.username?"":$scope.login.username.trim(),email=null==$scope.login.email?"":$scope.login.email.trim(),phone=null==$scope.login.phone?"":$scope.login.phone.trim(),content=$scope.login.content,service=$scope.login.selectedService
$scope.validateUser(name,email,phone)
var afValid=$scope.login.validateAdditionFields($scope.lstAdditionField)
if(""==content?$scope.requiredContent=!0:$scope.requiredContent=!1,-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1,!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requiredContent||$scope.requireService)&&afValid){if(""!=name){$scope.isSendOffline=!0,$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone,$scope.chatState.setAdditionFields($scope.lstAdditionField,$scope.login)
var infoVisitor=new InfoVisitor
infoVisitor.setBasicInfo(name,email,phone),infoVisitor.setAdditionInfo($scope.lstAdditionField,$scope.login),$scope.visitorInfo.setBasicInfo(name,email,phone),send(UPDATE_VISITOR_INFO,infoVisitor)}var host=document.location.host
parent!==window&&(host=document.referrer)
var sendMessage={message:content,service_id:service.serviceId,host_name:$scope.currentPageUrl,url:host}
send(CUSTOMER_SEND_OFFLINE_MESSAGE,sendMessage),saveChatStateToStorage()}},$scope.openOptionBox=function(e){$scope.isClickOption=!$scope.isClickOption,$scope.isClickSignin=!1,$scope.isClickOption?$scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openOptionBox,"option-menu",e)}:($scope.$window.onclick=null,void 0==e&&$scope.$apply())},$scope.showUserInfoEdit=function(){$scope.isChangeUserInfo=!0},$scope.signout=function(){$scope.chatState.visitor_id="-1",$scope.chatState.visitor_name="",$scope.chatState.visitor_email="",$scope.chatState.visitor_phone="",$scope.login.setBasicInfo(null,null,null),$scope.userInfo.setBasicInfo(null,null,null),$scope.visitorInfo.setBasicInfo(null,null,null),$scope.chatState.setDefaultAdditionFieldsValue($scope.lstAdditionField),$scope.login.setDefaultAdditionFieldsValue($scope.lstAdditionField),$scope.userInfo.setDefaultAdditionFieldsValue($scope.lstAdditionField),$scope.isChangeUserInfo=!0,saveChatStateToStorage()},$scope.openEditInfo=function(){if($scope.isClickOption=!1,$scope.isClickSignin=!0,$scope.isEditUserInfo=!0,$scope.userInfo.setBasicInfo($scope.visitorName.visitorName,$scope.visitorName.visitorName,$scope.visitorName.visitorPhone),$scope.chatState.service_id&&-1==$scope.chatState.service_id)$scope.userInfo.selectedService=$scope.listService[0]
else for(var i=0;i<$scope.listService.length;i++)$scope.chatState.service_id==$scope.listService[i].serviceId&&($scope.userInfo.selectedService=$scope.listService[i])
$scope.requiredName=!1,$scope.requiredEmail=!1,$scope.requiredPhone=!1,$scope.requiredContent=!1,$scope.requireService=!1,$scope.invalidEmail=!1,$scope.invalidPhone=!1},$scope.closeEditInfo=function(){$scope.isEditUserInfo=!1,$scope.isClickSignin=!1},$scope.confirmEndChat=function(e){$scope.isConfirmEnd=!0,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null),$scope.commentMessage=new Comment,isTouchEvent||($scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,function(){$scope.isConfirmEnd=!1,$scope.$window.onclick=null,$scope.$digest()},"confirm-end",e)})},$scope.cancelEndChat=function(){$scope.isConfirmEnd=!1,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null)},$scope.submitEndChat=function(){$scope.isConfirmEnd=!1,$scope.isClickOption=!1,isTouchEvent||($scope.$window.onclick=null),null!==$scope.chatState.agent_name?$scope.isRating=!0:endConversation()},$scope.skipRating=function(){endConversation()},$scope.isValidRating=!0,$scope.submitRating=function(){if(!$scope.isLike&&!$scope.isDislike)return void($scope.isValidRating=!1)
if(""!=$scope.commentMessage.content){var comment={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,content:$scope.commentMessage.content}
send(COMMENT,comment),sendTrackingEvent("rating_has_comment",null)}endConversation()},$scope.dislike=function(){$scope.isValidRating=!0
var dislike={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(DISLIKE,dislike)},$scope.like=function(){$scope.isValidRating=!0
var like={visitorId:$scope.chatState.visitor_id,serviceId:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id}
send(LIKE,like)},$scope.openSigninBox=function(e){$scope.isClickOption=!1,$scope.isClickSignin=!$scope.isClickSignin,$scope.isClickSignin?$scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openEditInfoBox,"sign-in-menu",e)}:($scope.$window.onclick=null,void 0==e&&$scope.$apply())},$scope.showUserInfoEditMo=function(){$scope.isEditUserInfo=!0},$scope.openEditInfoBox=function(e){if($scope.isClickOption=!1,$scope.isClickSignin=!$scope.isClickSignin,$scope.isClickSignin){if($scope.preventCloseDiv=!1,$scope.isEditUserInfo=!1,""==$scope.login.username?($scope.userInfo.username="",$scope.isEditUserInfo=!0,$scope.userInfo.selectedService=$scope.listService[0]):$scope.userInfo.username=$scope.visitorInfo.visitorName,$scope.chatState.service_id&&-1==$scope.chatState.service_id)$scope.isEditUserInfo=!0,$scope.userInfo.selectedService=$scope.listService[0]
else for(var i=0;i<$scope.listService.length;i++)$scope.chatState.service_id==$scope.listService[i].serviceId&&($scope.userInfo.selectedService=$scope.listService[i])
$scope.userInfo.email=$scope.visitorInfo.visitorEmail,$scope.userInfo.phone=$scope.visitorInfo.visitorPhone,$scope.userInfo.setAdditionFields($scope.lstAdditionField,$scope.chatState.visitorAdditionField),$scope.isMobile||$scope.preventCloseDiv&&($scope.$window.onclick=function(event){closeDivWhenClickingElsewhere(event,$scope.openEditInfoBox,"sign-in-menu",e)})}else $scope.$window.onclick=null,void 0==e&&$scope.$apply()},$scope.validateInfo=function(){var valid=!0
return valid=$scope.login.validateAdditionFields($scope.lstAdditionField),($scope.requirePhone&&""===$scope.login.phone||$scope.requireEmail&&""===$scope.login.email||-1==$scope.chatState.service_id)&&(valid=!1),valid},$scope.submitChat=function(event){if(13!==event.which&&0!=event||null==$scope.chatMessage.attachments||$scope.uploadFile($scope.chatMessage.attachments,uploadUrl),(13===event.which||0==event)&&""!=$scope.chatMessage.content){if(0!=event&&event.preventDefault(),0==$scope.validateInfo())return void $scope.openEditInfoBox()
if(null==$scope.chatState.chatting||0==$scope.chatState.chatting){var sendMessage={service_id:$scope.chatState.service_id?$scope.chatState.service_id:-1,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:$scope.chatMessage.content,fromTrigger:$scope.chatState.replyFromTrigger,logging:"submitchat - chatting = false"}
if("-1"==sendMessage.conversationId){sendMessage.lstTriggerMsg=gatherTriggerMsg($scope.chatState.history),$scope.isCustomerChatting=!0
var sendMenu={serviceId:$scope.chatState.service_id}
send(LIVECHAT_GET_PERSISTENT_MENU,sendMenu)}$scope.chatState.chatting=!0,sendTrackingEvent("start_chat",null),send(MESSAGE,sendMessage)}else{var msg={service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,message:$scope.chatMessage.content,fromTrigger:$scope.chatState.replyFromTrigger,logging:"submitchat - chatting = true"}
if("-1"==msg.conversationId){msg.lstTriggerMsg=gatherTriggerMsg($scope.chatState.history),$scope.isCustomerChatting=!0
var sendMenu={serviceId:$scope.chatState.service_id}
send(LIVECHAT_GET_PERSISTENT_MENU,sendMenu)}send(MESSAGE,msg)}stopNotifyTypingToCust(),$scope.chatMessage.content="",$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),clearTimeout($scope.tmroutCheckAgentStat)}if(1!=$scope.isKeyPress){$scope.isKeyPress=!0
var req={conversationId:$scope.chatState.conversation_id}
send(NOTIFY_TYPING,req),keypressChatTimeout=setTimeout(function(){stopNotifyTypingToCust()},5e3)}else clearTimeout(keypressChatTimeout),keypressChatTimeout=setTimeout(function(){stopNotifyTypingToCust()},5e3)},$scope.onClickSubmitChat=function(event){if($("#chat-text-area").focus(),""!=$scope.chatMessage.content){if(0==$scope.validateInfo())return void $scope.openEditInfoBox()
if(null==$scope.chatState.chatting||0==$scope.chatState.chatting){var sendMessage={service_id:$scope.chatState.service_id?$scope.chatState.service_id:-1,conversationId:$scope.chatState.conversation_id?$scope.chatState.conversation_id:"-1",message:$scope.chatMessage.content,fromTrigger:$scope.chatState.replyFromTrigger,logging:"onclicksubmitchat - chatting = false"}
"-1"==sendMessage.conversationId&&(sendMessage.lstTriggerMsg=gatherTriggerMsg($scope.chatState.history),$scope.isCustomerChatting=!0),$scope.chatState.chatting=!0,sendTrackingEvent("start_chat",null),send(MESSAGE,sendMessage)}else{var msg={service_id:$scope.chatState.service_id,conversationId:$scope.chatState.conversation_id,message:$scope.chatMessage.content,fromTrigger:$scope.chatState.replyFromTrigger,logging:"onclicksubmitchat - chatting = true"}
"-1"==msg.conversationId&&(msg.lstTriggerMsg=gatherTriggerMsg($scope.chatState.history),$scope.isCustomerChatting=!0),send(MESSAGE,msg)}stopNotifyTypingToCust(),$scope.chatMessage.content="",clearTimeout($scope.tmroutCheckAgentStat),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}},$scope.validateUser=function(name,email,phone){""==name?$scope.requiredName=!0:$scope.requiredName=!1,$scope.requireEmail&&(""==email?$scope.requiredEmail=!0:$scope.requiredEmail=!1),isValidEmailAddress(email)||""==email?$scope.invalidEmail=!1:$scope.invalidEmail=!0,$scope.requirePhone&&(""==phone?$scope.requiredPhone=!0:$scope.requiredPhone=!1),isValidPhoneNumber(phone)||""==phone?$scope.invalidPhone=!1:$scope.invalidPhone=!0},$scope.editUserInfo=function(){var name=null==$scope.userInfo.username?"":$scope.userInfo.username.trim(),email=null==$scope.userInfo.email?"":$scope.userInfo.email.trim(),phone=null==$scope.userInfo.phone?"":$scope.userInfo.phone.trim()
if($scope.listService.length>1)var service=$scope.userInfo.selectedService
$scope.validateUser(name,email,phone),$scope.listService.length>1&&(-1==service.serviceId?$scope.requireService=!0:$scope.requireService=!1)
var afValid=$scope.userInfo.validateAdditionFields($scope.lstAdditionField)
if(afValid&&!($scope.requiredName||$scope.requiredEmail||$scope.invalidEmail||$scope.requiredPhone||$scope.invalidPhone||$scope.requireService)){$scope.chatState.visitor_name=name,$scope.chatState.visitor_email=email,$scope.chatState.visitor_phone=phone,$scope.chatState.setAdditionFields($scope.lstAdditionField,$scope.userInfo),$scope.listService.length>1&&($scope.chatState.service_id=service.serviceId),$scope.isSignin=!0,$scope.visitorInfo.setBasicInfo(name,email,phone),$scope.visitorInfo.setAdditionFields($scope.lstAdditionField,$scope.userInfo),$scope.login.setBasicInfo(name,email,phone),$scope.login.setAdditionFields($scope.lstAdditionField,$scope.userInfo),$scope.isClickSignin=!1,$scope.$window.onclick=null,$scope.isEditInfo=!1,saveChatStateToStorage()
var infoVisitor=new InfoVisitor
infoVisitor.setBasicInfo(name,email,phone),infoVisitor.setAdditionInfo($scope.lstAdditionField,$scope.userInfo),$scope.visitorInfo.setBasicInfo(name,email,phone),send(UPDATE_VISITOR_INFO,infoVisitor),isSynced=!1}},$scope.onFileSelected=function(scope){var file=scope.myFile
return $scope.isClickOption=!1,$scope.$window.onclick=null,file.size>3145728?void alert($filter("translate")("LBL_FILE_SIZE")):0==/.*\.(png|jpg|jpeg|gif|doc|docx|txt|rtf|pdf|xls|xlsx|csv)$/.test(file.name.toLowerCase())?void alert($filter("translate")("LBL_CHAT_UPLOAD_ERR_EXTENSION")):void $scope.uploadFile(file,uploadUrl,"")},$scope.uploadOnSelect=function(file){void 0!=file&&null!=file&&Upload.upload({url:uploadUrl,data:{fileUp:file}}).then(function(resp){log("Success "+resp.config.data.file.name+"uploaded. Response: "+resp.data)},function(resp){log("Error status: "+resp.status)},function(evt){log("progress: "+progressPercentage+"% "+evt.config.data.file.name)})},$scope.test=function(pasteEvent){var clipData=pasteEvent.clipboardData||pasteEvent.originalEvent.clipboardData
angular.forEach(clipData.items,function(item,key){if(clipData.items[key].type.match(/image.*/)){var img=clipData.items[key].getAsFile()
if(log("A image sized "+img.size+" is being uploaded."),img.size>$scope.maxUploadSize)return $.jGrowl($filter("translate")("MAX_SIZE_UPLOAD"),{theme:"error"}),!1
var fd=new FormData
fd.append("fileUp",img),""==img.name?fd.append("fileUp",img):fd.append("fileUp",img,img.name),log(img),log(angular.identity),$http.post(uploadUrl,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(url){log(url)}).error(function(data){log(data)})}})},$scope.removeAttachment=function(conv){conv.attachments=null},$scope.onPasteAttachment=function(pasteEvent,conv){if($scope.allowRating){var clipData=pasteEvent.clipboardData||pasteEvent.originalEvent.clipboardData
angular.forEach(clipData.items,function(item,key){if(clipData.items[key].type.match(/image.*/)){var img=clipData.items[key].getAsFile()
if(log("A image sized "+img.size+" is being uploaded."),img.size>$scope.maxUploadSize)return alert($filter("translate")("LBL_FILE_SIZE")),!1
if(0==/.*\.(png|jpg|jpeg|gif|doc|docx|txt|rtf|pdf|xls|xlsx|csv)$/.test(img.name.toLowerCase()))return alert($filter("translate")("LBL_CHAT_UPLOAD_ERR_EXTENSION")),!1
conv.attachments=img}})}},$scope.processFiles=function(files){$scope.confirmImage=[]
for(var i=0;i<files.length;i++)if(1==/.*\.(png|jpg|jpeg)$/.test(files[i].name.toLowerCase())){var fileReader=new FileReader
fileReader.filename=files[i].name,fileReader.onload=function(event){var uri=event.target.result
$scope.confirmImage.push({type:"photo",name:event.target.filename,source:uri}),$scope.$digest()},fileReader.readAsDataURL(files[i].file)}else $scope.confirmImage.push({type:"file",name:files[i].name})},$scope.uploadFile=function(file,uploadUrl,fileName){if($scope.uploading)alert($filter("translate")("LBL_UPLOADING"))
else{$scope.uploading=!0
var fd
"undefined"==typeof FormData?($scope.uploading=!1,alert($filter("translate")("LBL_BROWSER_NOT_SUPPORT"))):(fd=new FormData,""==fileName?fd.append("fileUp",file):fd.append("fileUp",file,fileName),$http.post(uploadUrl,fd,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(result){if(0==result.data.result)$scope.uploading=!1,alert($filter("translate")("LBL_UPLOAD_FAIL"))
else{var uploadMessage={conversationId:$scope.chatState.conversation_id,fileId:result.data.fileId,fileName:result.data.fileName,url:result.data.url}
send(SEND_FILE,uploadMessage)}},function(){$scope.uploading=!1,alert($filter("translate")("LBL_UPLOAD_FAIL"))}))}},$scope.sendVisitorInfo=function(){var host=document.location.host
parent!==window&&(host=document.referrer)
var url={url:$scope.currentPageUrl,title:$scope.pageTitle?$scope.pageTitle:null,referrer:$scope.referrer?$scope.pageTitle:null}
send(VISITOR_VISIT_PATH_URL,url)},$scope.addNewVersionChatStateInfo=function(){$scope.chatState.triggerState||($scope.chatState.triggerState=[]),(void 0==$scope.chatState.replyFromTrigger||null==$scope.chatState.replyFromTrigger)&&($scope.chatState.replyFromTrigger=0)},$scope.onPostBackButton=function(item){var data={conversationId:$scope.chatState.conversation_id,serviceId:$scope.chatState.service_id,accountId:$scope.accountId,payload:item.payload,title:item.title}
$scope.leftSlider=0,send(POST_BACK_BUTTON,data)},$scope.checkRightSlider=function(index,message){return $sliderLength=$("#quickRepliesSuggestion_"+index).width(),message.leftSlider-260>-$sliderLength?!0:!1},$scope.prevSlider=function(index,message){message.leftSlider+=100,message.leftSlider>0&&(message.leftSlider=0)},$scope.nextSlider=function(index,message){var length=$("#quickRepliesSuggestion_"+index).width()
message.leftSlider-=100,message.leftSlider-260<-length&&(message.leftSlider=-length+255)},$scope.checkRightSliderGallery=function(index,message){var length=$("#gallerySuggestion_"+index).width()
return message.leftSlider-165>-length?!0:!1},$scope.prevGallery=function(index,message){message.leftSlider+=165,message.leftSlider>0&&(message.leftSlider=0)},$scope.nextGallery=function(index,message){var length=$("#gallerySuggestion_"+index).width()
message.leftSlider-=165,message.leftSlider-165<-length&&(message.leftSlider=-length+165)},$scope.doInitDomain=function(domain,parentUsername){DomainService.getChat(domain,parentUsername).then(function(data){if(null!=data&&void 0!=data&&(!data.data||1!=data.data.is_banned)){var addition_setting=data.data.addition_setting?angular.fromJson(data.data.addition_setting):null
if(addition_setting&&1==addition_setting.chat_version_2)return $scope.changeVersion(2),void console.debug("change chat version to react")
$scope.useFacebook=1==data.data.useFacebook,null!=data.data.pageId&&""!=data.data.pageId&&($scope.pageId=data.data.pageId),$scope.useFacebook||(CS_WEB_PUSH=data.data.chatServer,uploadUrl=data.data.uploadUrl,webPush.connect(CS_WEB_PUSH,0)),$scope.lstAdditionField=data.data.lstAdditionField
for(var i=0;i<$scope.lstAdditionField.length;i++)3==$scope.lstAdditionField[i].type&&$scope.lstAdditionField[i].data.unshift({id:-1,description:"-- "+$scope.lstAdditionField[i].field_label+" --",user_field_id:$scope.lstAdditionField[i].user_field_id})
$scope.userInfo.setDefaultAdditionFieldsValue($scope.lstAdditionField),$scope.login.setDefaultAdditionFieldsValue($scope.lstAdditionField),$scope.serviceName=data.data.domainValue,$scope.domainCode=data.data.domainCode,$scope.domainPath=data.data.path,$scope.accountId=data.data.accountId,$scope.clientIp=data.data.clientIp,$scope.isMobile?(null!=data.data.color_mobile&&""!=data.data.color_mobile?$scope.backgroundColor=data.data.color_mobile:null!=data.data.color&&""!=data.data.color&&($scope.backgroundColor=data.data.color),null!=data.data.off_title_mobile&&""!=data.data.off_title_mobile?$scope.offTitle=data.data.off_title_mobile:null!=data.data.offTitle&&""!=data.data.offTitle&&($scope.offTitle=data.data.offTitle),null!=data.data.on_title_mobile&&""!=data.data.on_title_mobile?$scope.onTitle=data.data.on_title_mobile:null!=data.data.onTitle&&""!=data.data.onTitle&&($scope.onTitle=data.data.onTitle),null!=data.data.avatar_mobile&&""!=data.data.avatar_mobile?$scope.agentAvatarDefault=data.data.avatar_mobile:null!=data.data.avatar&&""!=data.data.avatar&&($scope.agentAvatarDefault=data.data.avatar),null!=data.data.agent_name_mobile&&""!=data.data.agent_name_mobile?$scope.agentNameDefault=data.data.agent_name_mobile:null!=data.data.agentName&&""!=data.data.agentName&&($scope.agentNameDefault=data.data.agentName),null!=data.data.agent_title_mobile&&""!=data.data.agent_title_mobile?$scope.agentDescriptionDefault=data.data.agent_title_mobile:null!=data.data.agentTitle&&""!=data.data.agentTitle&&($scope.agentDescriptionDefault=data.data.agentTitle),null!=data.data.agent_busy_mobile&&""!=data.data.agent_busy_mobile?$scope.agentBusyDefault=data.data.agent_busy_mobile:null!=data.data.agentBusy&&""!=data.data.agentBusy&&($scope.agentBusyDefault=data.data.agentBusy),null!=data.data.offline_info_mobile&&""!=data.data.offline_info_mobile?$scope.offlineInfo=data.data.offline_info_mobile:null!=data.data.offlineInfo&&""!=data.data.offlineInfo&&($scope.offlineInfo=data.data.offlineInfo),null!=data.data.SEND_SUCCESS_MOBILE&&""!=data.data.SEND_SUCCESS_MOBILE?$scope.offlineSuccess=data.data.SEND_SUCCESS_MOBILE:null!=data.data.sendSuccess&&""!=data.data.sendSuccess&&($scope.offlineSuccess=data.data.sendSuccess),$scope.widget_logo_custom=data.data.widget_logo_custom?data.data.widget_logo_custom:"",$scope.widget_position_mobile=data.data.widget_position_mobile?data.data.widget_position_mobile:2,$scope.widget_type1_logo_mobile=data.data.widget_type1_logo_mobile?data.data.widget_type1_logo_mobile:1,$scope.widget_type_mobile=data.data.widget_type_mobile?data.data.widget_type_mobile:1,$scope.changeWidgetType($scope.widget_type_mobile),$scope.changeWidgetPosition($scope.widget_position_mobile),$scope.enableEmail=null!==data.data.ENABLE_EMAIL_MOBILE&&""!==data.data.ENABLE_EMAIL_MOBILE?1==data.data.ENABLE_EMAIL_MOBILE:1==data.data.enableEmail,$scope.requireEmail=null!==data.data.REQUIRED_EMAIL_MOBILE&&""!==data.data.REQUIRED_EMAIL_MOBILE?1==data.data.REQUIRED_EMAIL_MOBILE:1==data.data.requiredEmail,$scope.enablePhone=null!==data.data.ENABLE_PHONE_MOBILE&&""!==data.data.ENABLE_PHONE_MOBILE?1==data.data.ENABLE_PHONE_MOBILE:1==data.data.enablePhone,$scope.requirePhone=null!==data.data.REQUIRED_PHONE_MOBILE&&""!==data.data.REQUIRED_PHONE_MOBILE?1==data.data.REQUIRED_PHONE_MOBILE:1==data.data.requiredPhone):(null!=data.data.color&&""!=data.data.color&&($scope.backgroundColor=data.data.color),null!=data.data.offTitle&&""!=data.data.offTitle&&($scope.offTitle=data.data.offTitle),null!=data.data.onTitle&&""!=data.data.onTitle&&($scope.onTitle=data.data.onTitle),null!=data.data.avatar&&""!=data.data.avatar&&($scope.agentAvatarDefault=data.data.avatar),null!=data.data.agentName&&""!=data.data.agentName&&($scope.agentNameDefault=data.data.agentName),null!=data.data.agentTitle&&""!=data.data.agentTitle&&($scope.agentDescriptionDefault=data.data.agentTitle),null!=data.data.agentBusy&&""!=data.data.agentBusy&&($scope.agentBusyDefault=data.data.agentBusy),null!=data.data.offlineInfo&&""!=data.data.offlineInfo&&($scope.offlineInfo=data.data.offlineInfo),null!=data.data.sendSuccess&&""!=data.data.sendSuccess&&($scope.offlineSuccess=data.data.sendSuccess),null!=data.data.sendSuccess&&""!=data.data.sendSuccess&&($scope.offlineSuccess=data.data.sendSuccess),$scope.enableEmail=1==data.data.enableEmail,$scope.requireEmail=1==data.data.requiredEmail,$scope.enablePhone=1==data.data.enablePhone,$scope.requirePhone=1==data.data.requiredPhone),null!=data.data.logoUrl&&""!=data.data.logoUrl&&($scope.homepage=data.data.logoUrl),null!=data.data.logoImage&&""!=data.data.logoImage&&($scope.logo=data.data.logoImage),null!=data.data.logoDescription&&""!=data.data.logoDescription&&($scope.titleLogo=data.data.logoDescription),$scope.lstTrigger=data.data.lstTrigger
for(var i=0;i<$scope.lstTrigger.length;i++)for(var j=0;j<$scope.lstTrigger[i].conditions.length;j++)("visitor_time_on_site"==$scope.lstTrigger[i].conditions[j].field||"visitor_time_on_page"==$scope.lstTrigger[i].conditions[j].field)&&($scope.lstTrigger[i].needInterval=!0)
if($scope.autoPopup=0,$scope.autoPopup&&($scope.autoMessage=data.data.autoMessage,$scope.autoName=data.data.autoName,$scope.autoType=data.data.autoType,$scope.autoTime=data.data.autoTime,$scope.autoService=data.data.autoServiceId,$scope.autoDelay=data.data.autoDelay),""==language||"vi"!=language&&"en"!=language?$scope.language=data.data.language:$scope.language=language,TranslateService.translate($scope.language),!$scope.useFacebook&&null!=data.data.listService&&0!=data.data.listService.length){if($.each(data.data.listService,function(ind,val){$scope.listServiceStr+=val.serviceId+";"}),$scope.domainId=data.data.domainId,null==$scope.localStorage.getItem("chatState_devicekey_"+$scope.domainId)){var device_key=encodeURIComponent(btoa((new Date).getTime()))
$scope.localStorage.setItem("chatState_devicekey_"+$scope.domainId,device_key)
var datasend={id:6,type:"saveIfrChatStateDeviceKey",value:{name:"chatState_devicekey_"+$scope.domainId,value:device_key}}
parent.postMessage(JSON.stringify(datasend),"*")}$scope.isMobile?((null===data.data.REQUIRED_EMAIL_MOBILE||""===data.data.REQUIRED_EMAIL_MOBILE)&&(data.data.REQUIRED_EMAIL_MOBILE=data.data.requiredEmail),(null===data.data.REQUIRED_PHONE_MOBILE||""===data.data.REQUIRED_PHONE_MOBILE)&&(data.data.REQUIRED_PHONE_MOBILE=data.data.requiredPhone),0==data.data.REQUIRED_EMAIL_MOBILE&&0==data.data.REQUIRED_PHONE_MOBILE?$scope.needSignin=!1:$scope.needSignin=!0):0==data.data.requiredEmail&&0==data.data.requiredPhone?$scope.needSignin=!1:$scope.needSignin=!0,$scope.listService=data.data.listService,markLanding(),initWorkspace()}}})},$scope.reconnect=function(){$scope.connecting=!0,$scope.currentResumeState=0,webPush.connect(CS_WEB_PUSH,0),restoreChatState()},webPush.onMessageReceived=function(dataReceived){log("Server response: "+JSON.stringify(dataReceived))
var mes,data=dataReceived.data,type=dataReceived.type
switch(type){case CUSTOMER_LOGIN:var name,email,phone
name=null!=data.name?void 0!=parentUsername&&null!=parentUsername&&""!=parentUsername?parentUsername:$scope.chatState.visitor_name||data.name:void 0!=parentUsername&&null!=parentUsername&&""!=parentUsername?parentUsername:$scope.chatState.visitor_name,email=null!=data.email?void 0!=parentEmail&&null!=parentEmail&&""!=parentEmail?parentEmail:$scope.chatState.visitor_email||data.email:void 0!=parentEmail&&null!=parentEmail&&""!=parentEmail?parentEmail:$scope.chatState.visitor_email,phone=void 0!=parentPhone&&null!=parentPhone&&""!=parentPhone?parentPhone:$scope.chatState.visitor_phone
var additionFields=data.additionFields||$scope.chatState.visitorAdditionField
$scope.visitorInfo.setBasicInfo(name,email,phone),$scope.visitorInfo.setAdditionFields($scope.lstAdditionField,additionFields),$scope.chatState.visitor_id=data.userId,isFirstLogin=!0,$scope.loggedinFirstTime=!0,$scope.inApp&&$scope.openChatBox(!0),saveChatStateToStorage(),$scope.$digest()
break
case MESSAGE:if($scope.chatState.conversation_id=data.conversationId,$scope.chatState.service_id=data.serviceId,!isSynced){$scope.isChatting=!0
var storageStr=$scope.localStorage.getItem("chatState_"+$scope.domainId),storage=JSON.parse(storageStr)
$scope.chatState.visitor_name=storage.visitor_name,$scope.chatState.visitor_email=storage.visitor_email,$scope.chatState.visitor_phone=storage.visitor_phone,$scope.visitorInfo.setBasicInfo(storage.visitor_name,storage.visitor_email,storage.visitor_phone),$scope.login.setBasicInfo($scope.visitorInfo.visitorName,$scope.visitorInfo.visitorEmail,$scope.visitorInfo.visitorPhone),$scope.userInfo.setBasicInfo($scope.visitorInfo.visitorName,$scope.visitorInfo.visitorEmail,$scope.visitorInfo.visitorPhone),$scope.isLike=$scope.chatState.isLike=storage.isLike,$scope.isDislike=$scope.chatState.isDislike=storage.isDislike,""!==$scope.visitorInfo.visitorName&&($scope.isSignin=!0),$scope.chatState.visitor_id=storage.visitor_id,isSynced=!0}if(data.needShow===!0){var msgData=new Message(null,1,data.message,data.time),msg=new Message(null,1,getMessageChat(data.message),data.time)
$scope.chatState.history.push(msgData),$scope.listMessage.push(msg)}$scope.sendLandingInfo(data.conversationId),$scope.$digest(),saveChatStateToStorage(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case HAVE_MESSAGE:if(data.conversationId==$scope.chatState.conversation_id){if(1==$scope.chatState.enableSound&&messageAudio.play(),4==data.messageType){var content=JSON.parse(data.message),chatContent=""
null!=content.attachment?"template"==content.attachment.type?chatContent=getMessageChat(content.attachment.payload.text):("video"==content.attachment.type||"audio"==content.attachment.type||"file"==content.attachment.type||"image"==content.attachment.type)&&(chatContent=getMessageChat(content.attachment.payload.url)):null!=content.quick_replies&&(chatContent=getMessageChat(content.text))
var fromName=data.fromFullname,senderAgentId=fromName,msgData=new Message(senderAgentId,5,chatContent,data.time)
msgData.botContent=content,msgData.leftSlider=0
var logChatData=new Message(senderAgentId,5,chatContent,data.time)
logChatData.botContent=content,logChatData.leftSlider=0,$scope.chatState.history.push(msgData),$scope.maximize||($scope.newMessage++,$scope.chatState.unreadCount++)}else{var content=data.message,fromName=data.fromFullname,senderAgentId=fromName,msgData=new Message(senderAgentId,2,content,data.time),logChatData=new Message(senderAgentId,2,getMessageChat(content),data.time)
$scope.chatState.history.push(msgData),$scope.maximize||($scope.newMessage++,$scope.chatState.unreadCount++)}$scope.listMessage.push(logChatData),saveChatStateToStorage(),sendTrackingEvent("incoming_message",{message:msgData.content,sender:senderAgentId,content_type:"text"}),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight")),$scope.isMobile||$scope.openChatBox()}break
case LIVECHAT_RETURN_PERSISTENT_MENU:$scope.botMenu=data.menuList
break
case USER_JOIN_CONVERSATION:mes=data.username+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_END_CONVERSATION_CUSTOMER:mes=data.fullName+$filter("translate")("LBL_END_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.agent_name=null,$scope.chatState.agent_group=null,$scope.chatState.agent_avatar=null,saveChatStateToStorage(),$scope.allowRating=!1,$scope.isTyping=!1,$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault,$scope.changeLandingSendState(!1),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_INFO_CUSTOMER:if($scope.chatState.agent_name!=data.fullName){$scope.chatState.agent_name=data.fullName?data.fullName:$scope.agentNameDefault,$scope.chatState.agent_group=data.service_name?data.service_name:$scope.agentDescriptionDefault,$scope.chatState.agent_avatar=data.avatar?data.avatar:$scope.agentAvatarDefault,$scope.agentName=data.fullName?data.fullName:$scope.agentNameDefault,$scope.agentDescription=data.service_name?data.service_name:$scope.agentDescriptionDefault,$scope.avatar=data.avatar?data.avatar:$scope.agentAvatarDefault,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.allowRating=!0,$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}var customerInfo={customer_name:$scope.chatState.visitor_name,customer_phone:$scope.chatState.visitor_phone,customer_mail:$scope.chatState.visitor_email,customer_ip:$scope.clientIp,customer_current_page:getVisitorCurrentURL(),chat_start_time:(new Date).getTime()}
data.customerInfo=customerInfo,$scope.$digest()
break
case AGENT_JOIN_CONVERSATION:var customerInfo={customer_name:$scope.chatState.visitor_name,customer_phone:$scope.chatState.visitor_phone,customer_mail:$scope.chatState.visitor_email,customer_ip:$scope.clientIp,customer_current_page:getVisitorCurrentURL(),chat_start_time:(new Date).getTime()}
data.customerInfo=customerInfo,sendTrackingEvent("agent_join_conversation",data)
break
case TRANSFER_CHAT_RESPONSE:mes=$scope.chatState.agent_name+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.agent_name=data.fullName,$scope.chatState.agent_group=data.service_name,$scope.chatState.agent_avatar=data.avatar?data.avatar:$scope.agentAvatarDefault,$scope.agentName=data.fullName,$scope.agentDescription=data.service_name,$scope.avatar=data.avatar?data.avatar:$scope.agentAvatarDefault,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CHAT_SUPER_SUPPORT_END:mes=data.fullName+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case SUPPORT_CHAT_RESPONSE:mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case RESPONSE_AGENT_MISS_CHAT_TO_CUSTOMER:var logChatData=new Message(null,3,$scope.agentBusyDefault)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.changeLandingSendState(!1),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CUSTOMER_RESUMING_RESPONSE:var res=data.r
if(1==res){$scope.currentResumeState=res,restoreChatBox(),$scope.isOffline=!1,$scope.sendVisitorInfo(),$scope.listMessage=[]
for(var i=0;i<data.messages.length;i++){var logChatData,content=null,sender="",senderType=1
if(data.messages[i].senderAgentId?(sender=data.messages[i].senderAgentName,senderType=2):data.messages[i].senderVisitorId?(sender=data.messages[i].senderVisitorName,senderType=1):senderType=3,4==data.messages[i].type){var content=JSON.parse(data.messages[i].content),chatContent=""
null!=content.attachment?"template"==content.attachment.type?chatContent=getMessageChat(content.attachment.payload.text):("video"==content.attachment.type||"audio"==content.attachment.type||"file"==content.attachment.type||"image"==content.attachment.type)&&(chatContent=getMessageChat(content.attachment.payload.url)):null!=content.quick_replies&&(chatContent=getMessageChat(content.text))
var fromName=data.fromFullname,senderAgentId=fromName,msgData=new Message(senderAgentId,5,chatContent,data.time)
msgData.botContent=content,msgData.leftSlider=0,logChatData=new Message(senderAgentId,5,chatContent,data.time),logChatData.botContent=content,logChatData.leftSlider=0,$scope.chatState.history.push(msgData)}else if(2==data.messages[i].type){var jsonArr=JSON.parse(data.messages[i].content)
logChatData=new Message(sender,4,"",data.messages[i].time),logChatData.fileName=jsonArr.fileName,logChatData.url=jsonArr.url,isImageLink(jsonArr.fileName)&&(logChatData.isImage=1)}else content=data.messages[i].content,logChatData=new Message(sender,senderType,getMessageChat(content),data.messages[i].time)
$scope.listMessage.push(logChatData)}}else if(-2==res)$scope.currentResumeState=res,$scope.maximize=!1,$scope.isOffline=!0,sessionLogout(),notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),saveChatStateToStorage(),"support"==$scope.domainCode?setTimeout(function(){restoreChatState()},checkStatTmrDuration):setTimeout(function(){restoreChatState()},checkStatTmrDuration),setTimeout(function(){null!=$scope.localStorage.getItem("chatState_devicekey_"+$scope.domainId)?setTimeout(function(){requestFirstLogin()},1e3):requestFirstLogin()},1e3)
else{if($scope.tmroutCheckAgentStat=setTimeout(function(){restoreChatState()},checkStatTmrDuration),res==$scope.currentResumeState)break
$scope.currentResumeState=res,isFirstLogin=!1,$scope.maximize=!1,$scope.isOffline=!1,log("resuming session failed"),sessionLogout(),$scope.fireTrigger(1),notifyNewMessage(hidePopup?$scope.isChatting?"closeChatBox":"closeChatBoxHide":"closeChatBox"),autoLoginTimeout=setTimeout(function(){requestFirstLogin()},3e3),!$scope.requireEmail&&!$scope.requirePhone&&""!=$scope.login.username&&$scope.listService.length<=1&&($scope.isSignin=!0),saveChatStateToStorage()}$scope.listService.length>1&&($scope.listService[0].serviceName=$filter("translate")("LBL_SELECT_ONE_SERVICE")),$scope.chat=!0,$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_LOGOUT:mes=data.fullName+$filter("translate")("LBL_LEAVE_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.$digest(),$scope.isTyping=!1,clearTimeout($scope.tmroutCheckAgentStat),$scope.tmroutCheckAgentStat=setTimeout(function(){restoreChatState()},checkStatTmrDuration),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case LIKE:var res=data.r
if(1===res){var rating=data.rating
if(0===rating){$scope.isLike=!1,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_REMOVE"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!1,saveChatStateToStorage(),sendTrackingEvent("remove_rating",null)}else{$scope.isLike=!0,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_GOOD"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!0,$scope.chatState.isDislike=!1,saveChatStateToStorage(),sendTrackingEvent("rating_good",null)}}else log("Rating failed")
$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case DISLIKE:var res=data.r
if(1===res){var rating=data.rating
if(0===rating){$scope.isLike=!1,$scope.isDislike=!1
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_REMOVE"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isDislike=!1,saveChatStateToStorage(),sendTrackingEvent("remove_rating",null)}else{$scope.isLike=!1,$scope.isDislike=!0
var logChatData=new Message(null,3,$filter("translate")("LBL_CHAT_BAD"))
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),$scope.chatState.isLike=!1,$scope.chatState.isDislike=!0,saveChatStateToStorage(),sendTrackingEvent("rating_bad",null)}}else log("Rating failed")
$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case SEND_FILE:var res=data.res
if(1==res){var logChatData=new Message(null,4,"")
logChatData.fileName=data.fileName,logChatData.url=data.url,isImageLink(data.fileName)&&(logChatData.isImage=1),$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage()}$scope.uploading=!1,$scope.chatMessage&&$scope.chatMessage.attachments&&($scope.chatMessage.attachments=null),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case RECEIVE_FILE:var logChatData=new Message(data.fromFullname,4,"")
logChatData.fileName=data.fileName,logChatData.url=data.url,isImageLink(data.fileName)&&(logChatData.isImage=1),$scope.maximize||($scope.newMessage++,$scope.chatState.unreadCount++),$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),sendTrackingEvent("incoming_message",{message:logChatData.url,sender:logChatData.senderAgent,content_type:"file",file_name:data.fileName}),saveChatStateToStorage(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case LEAVE_CONVERSATION:if(data.conversationId==$scope.chatState.conversation_id){$scope.chatState.conversation_id="-1",$scope.chatState.agent_name=null,$scope.chatState.agent_avatar=null
var mes=$filter("translate")("LBL_CHAT_ENDED"),logChatData=new Message(null,3,mes)
$scope.listMessage.push(logChatData),$scope.isRating=!1,$scope.allowRating=!1,$scope.isLike=!1,$scope.isDislike=!1,$scope.chatState.isLike=!1,$scope.chatState.isDislike=!1,$scope.chatState.replyFromTrigger=0,$scope.commentMessage.content="",$scope.agentName=$scope.agentNameDefault,$scope.agentDescription=$scope.agentDescriptionDefault,$scope.avatar=$scope.agentAvatarDefault}clearTimeout($scope.tmroutCheckAgentStat),$scope.tmroutCheckAgentStat=setTimeout(function(){restoreChatState()},checkStatTmrDuration),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case CUSTOMER_SEND_OFFLINE_MESSAGE:if(1==data.r){$scope.sentNotify=!0
var customerInfo={customer_name:$scope.chatState.visitor_name,customer_phone:$scope.chatState.visitor_phone,customer_mail:$scope.chatState.visitor_email,customer_ip:$scope.clientIp,customer_current_page:getVisitorCurrentURL(),chat_start_time:(new Date).getTime()}
sendTrackingEvent("offline_message_sent",customerInfo)}else $scope.sendOfflineError=!0
$scope.isSendOffline=!1,$scope.$digest()
break
case NOTIFY_TYPING:$scope.isTyping=!0,timeoutTyping=setTimeout(function(){$scope.isTyping=!1,$scope.$digest()},15e3),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case NOTIFY_STOP_TYPING:$scope.isTyping=!1,clearTimeout(timeoutTyping),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))
break
case AGENT_START_CHAT_WITH_CUSTOMER:if($scope.chatState.agent_name!=data.fullName){$scope.chatState.conversation_id=data.conversationId,$scope.chatState.agent_name=data.fullName,$scope.chatState.agent_group=data.serviceName,$scope.chatState.service_id=data.serviceId,$scope.chatState.chatting=!0,$scope.agentName=data.fullName,$scope.agentDescription=data.serviceName,$scope.avatar=data.avatar?data.avatar:$scope.agentAvatarDefault,mes=data.fullName+$filter("translate")("LBL_JOIN_CHAT")
var logChatData=new Message(null,3,mes)
$scope.chatState.history.push(logChatData),$scope.listMessage.push(logChatData),saveChatStateToStorage(),$scope.allowRating=!0,$scope.isChatting=!0,$scope.listService=[],""!=$scope.login.username&&($scope.isSignin=!0),$scope.isMobile||$scope.openChatBox(),$scope.$digest(),$(".chat-area").scrollTop($(".chat-area").prop("scrollHeight"))}else $scope.avatar=data.avatar
clearTimeout($scope.tmroutCheckAgentStat),sendTrackingEvent("agent_start_chat",data)}},$scope.doTriggerAction=function(trigger){switch($scope.chatState.triggerState.push({id:trigger.id,state:"fired"}),saveChatStateToStorage(),trigger.action){case 0:if($scope.isChatting&&1==$scope.isCustomerChatting){log("visitor is chatting with agent, close")
break}if($scope.userOpenChatBoxManually&&1!=$scope.chatState.replyFromTrigger){log("visitor open chat first, close")
break}$scope.isMobile?1!=$scope.maximize&&$scope.newMessage++:$scope.openChatBox()
var content=trigger.action_value,fromName=trigger.action_agent,senderAgentId=fromName,msgData=new Message(senderAgentId,2,content),logChatData=new Message(senderAgentId,2,getMessageChat(content))
msgData.isTriggerMsg=1,$scope.chatState.history.push(msgData),$scope.chatState.replyFromTrigger=1,$scope.listMessage.push(logChatData),$scope.isChatting=!0,$scope.$digest()}},$scope.changeWidgetType=function(type){var data={id:6,type:"changeWidgetType",value:type}
parent.postMessage(JSON.stringify(data),"*")},$scope.changeWidgetPosition=function(type,viewport){var data={id:6,type:"changeWidgetPosition",viewport:viewport,value:type}
parent.postMessage(JSON.stringify(data),"*")},$scope.changeVersion=function(version){var data={id:6,type:"changeVersion",version:version}
parent.postMessage(JSON.stringify(data),"*")},$scope.createTriggerIntvl=function(trigger){triggerIntvl[trigger.id]=setInterval(function(){var isFired=$scope.checkTriggerFireState(trigger)
if(isFired)return log("trigger already fired, close"),void clearInterval(triggerIntvl[trigger.id])
var pass=$scope.checkTgCond(trigger)
return pass?void("run"==pass?($scope.doTriggerAction(trigger),log("all condition valid, proceed")):"stop"==pass?(clearInterval(triggerIntvl[trigger.id]),log("None of condition are matched, stop the interval")):log("Waiting condition to match")):(console.error("Checker failed!"),void clearInterval(triggerIntvl[trigger.id]))},1e3)},$scope.checkTriggerFireState=function(trigger){for(var isFired=!1,i=0;i<$scope.chatState.triggerState.length;i++)trigger.id==$scope.chatState.triggerState[i].id&&(isFired=!0)
return isFired},$scope.prepareTrigger=function(index){setTimeout(function(){$scope.lstTrigger[index].needInterval?(log("Trigger has a condition that need interval, creating...."),$scope.createTriggerIntvl($scope.lstTrigger[index])):"run"==$scope.checkTgCond($scope.lstTrigger[index])?(log("Trigger not has a condition that need interval, fire..."),$scope.doTriggerAction($scope.lstTrigger[index])):log("trigger not fired")},1e3*$scope.lstTrigger[index].fire_delay)},$scope.fireTrigger=function(runTime){for(var i=0;i<$scope.lstTrigger.length;i++){var isFired=$scope.checkTriggerFireState($scope.lstTrigger[i])
$scope.lstTrigger[i].run_time!=runTime||isFired?log("already fired"):$scope.prepareTrigger(i)}},$scope.checkTgCond=function(trigger){var conditions=trigger.conditions,condRsArr=[],isPassed=!1,timeonsite={}
try{for(var i=0;i<conditions.length;i++){var realVal=$scope.getCondRealValue(conditions[i],trigger),configVal=conditions[i].value
"visitor_time_on_site"==conditions[i].field||"visitor_time_on_page"==conditions[i].field?(timeonsite={field:conditions[i].field,check:comparer[conditions[i].operator](realVal,configVal)},("equal"==conditions[i].operator||"less"==conditions[i].operator||"less_or_equal"==conditions[i].operator)&&realVal>configVal&&(timeonsite={field:conditions[i].field,check:comparer[conditions[i].operator](realVal,configVal),forceStop:!0}),condRsArr.push(timeonsite)):condRsArr.push({field:conditions[i].field,check:comparer[conditions[i].operator](realVal,configVal)})}isPassed=operatorsCheck[1==trigger.condition_operator?"or":"and"](condRsArr)}catch(e){console.error(e)}return isPassed}
var comparer={equal:function(a,b){return a==b},not_equal:function(a,b){return a!=b},contains:function(a,b){return a?("string"==typeof b&&(b=b.toLowerCase()),"string"==typeof a&&(a=a.toLowerCase()),a&&a.indexOf(b)>=0):!1},not_contains:function(a,b){return a?("string"==typeof b&&(b=b.toLowerCase()),"string"==typeof a&&(a=a.toLowerCase()),a&&-1==a.indexOf(b)):!1},greater:function(a,b){return a>b},less:function(a,b){return b>a},greater_or_equal:function(a,b){return a>=b},less_or_equal:function(a,b){return b>=a}},operatorsCheck={and:function(condRsArr){for(var state="run",i=0;i<condRsArr.length;i++){if("visitor_time_on_site"!=condRsArr[i].field&&"visitor_time_on_page"!=condRsArr[i].field&&0==condRsArr[i].check){state="stop"
break}if(("visitor_time_on_site"==condRsArr[i].field||"visitor_time_on_page"==condRsArr[i].field)&&0==condRsArr[i].check){state="retry",condRsArr[i].forceStop&&(state="stop")
break}}return state},or:function(condRsArr){for(var state="stop",i=0;i<condRsArr.length;i++)if(1==condRsArr[i].check){state="run"
break}return state}}
$scope.getCondRealValue=function(cond,trigger){var retVal
switch(cond.field){case"hour_of_day":var now=new Date
retVal=now.getHours()
break
case"day_of_week":retVal=(new Date).getDay()+1
break
case"day_of_month":retVal=(new Date).getDate()
break
case"month_of_year":retVal=(new Date).getMonth()+1
break
case"visitor_time_on_page":retVal=((new Date).getTime()/1e3|0)-$scope.currentTimeOnSite
break
case"visitor_time_on_site":var timeonsite=""
try{timeonsite=sessionStorage.getItem("cs_landingtime")}catch(err){timeonsite=$scope.sessionStorage.getItem("cs_landingtime")}retVal=((new Date).getTime()/1e3|0)-timeonsite
break
case"visitor_page_url":var host=document.location.host
parent!==window&&(host=document.referrer),retVal=$scope.currentPageUrl?$scope.currentPageUrl:host
break
case"visitor_page_title":retVal=$scope.pageTitle
break
case"referrer":retVal=$scope.referrer
break
case"visitor_name":retVal=$scope.visitorInfo.visitorName
break
case"visitor_email":retVal=$scope.visitorInfo.visitorEmail
break
case"visitor_phone":retVal=$scope.visitorInfo.visitorPhone
break
case"visitor_user_agent":retVal=navigator.userAgent
break
case"visitor_browser":retVal=$scope.browserInfo.browser.name
break
case"visitor_platform":retVal=$scope.browserInfo.os.name
break
case"visitor_ip":retVal=$scope.clientIp
break
case"visitor_device":retVal=$scope.browserInfo.device.type}return retVal},$scope.onUrlChangedSPA=function(url){$scope.currentPageUrl=url,$scope.fireTrigger(1)},window.addEventListener?window.addEventListener("message",displayMessage,!1):window.attachEvent("onmessage",displayMessage),getQueryString(),setLandingTime()}])
